<!DOCTYPE html>
<html>
<head>
  <base href="$FLUTTER_BASE_HREF">
  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="A new Flutter project.">
  <!-- iOS meta tags & icons, favicon, title, manifest 등 기존 그대로 -->
  <style>
    /* WebGazer의 비디오/캔버스 요소는 숨기되, 크기는 0×0이 아니도록 */
    #webgazerVideoFeed,
    #webgazerVideoContainer,
    #webgazerFaceOverlayCanvas {
      position: fixed;
      width: 1px !important;
      height: 1px !important;
      opacity: 0 !important;
      pointer-events: none;
    }
    /* 커스텀 포인터 스타일 */
    #gazeIndicator {
      position: absolute;
      width: 16px; height: 16px;
      background: rgba(255,0,0,0.7);
      border-radius: 50%;
      pointer-events: none;
      z-index: 9999;
      transform: translate(-50%, -50%);
    }
  </style>
</head>

<body>
  <script src="recorder.js"></script>
  <script src="https://unpkg.com/webgazer/dist/webgazer.js"></script>

  <script>
    window.startEyeTracking = async () => {
      // (1) 커스텀 포인터 요소가 없다면 생성
      if (!window._gazeIndicator) {
        const div = document.createElement('div');
        div.id = 'gazeIndicator';
        document.body.appendChild(div);
        window._gazeIndicator = div;
      }
      window._eyeData = [];

      // (2) WebGazer 시작 & 리스너 등록
      await webgazer
        .setGazeListener((data, timestamp) => {
          if (data) {
            // 포인터 위치 업데이트
            window._gazeIndicator.style.left = data.x + 'px';
            window._gazeIndicator.style.top  = data.y + 'px';
            // raw 데이터 저장
            window._eyeData.push({ x: data.x, y: data.y, t: timestamp });
          }
        })
        .begin();

      // (3) 웹캠 비디오 / 오버레이는 숨기기
      webgazer
        .showVideo(false)
        .showFaceOverlay(false)
        .showPredictionPoints(false);
    };

    window.stopEyeTracking = async () => {
      await webgazer.clearGazeListener();
      await webgazer.pause();
      // 포인터도 제거해 두면 깔끔
      if (window._gazeIndicator) {
        window._gazeIndicator.remove();
        window._gazeIndicator = null;
      }
      return window._eyeData;
    };
  </script>

  <script src="flutter_bootstrap.js" async></script>
</body>
</html>
